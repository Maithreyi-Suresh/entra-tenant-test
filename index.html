<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Tenant Registration Landing â€“ MSAL Auto-Fill</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f3f4f6;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        background: #ffffff;
        border-radius: 12px;
        padding: 24px;
        max-width: 480px;
        width: 100%;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        border: 1px solid #e5e7eb;
      }
      h1 {
        font-size: 1.25rem;
        margin-bottom: 8px;
        color: #111827;
      }
      p.small {
        font-size: 0.8rem;
        margin-bottom: 16px;
        color: #6b7280;
      }
      #error {
        color: #b91c1c;
        font-size: 0.8rem;
        margin-bottom: 10px;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      label {
        font-size: 0.8rem;
        color: #374151;
      }
      .required::after {
        content: " *";
        color: #ef4444;
      }
      input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 0.9rem;
      }
      input[readonly] {
        background: #f3f4f6;
      }
      button {
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        background: #2563eb;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
      }
      button:hover {
        background: #1d4ed8;
      }
    </style>

    <!-- MSAL.js -->
    <script src="https://alcdn.msauth.net/browser/2.44.0/js/msal-browser.min.js"></script>
    <!-- Tenant settings -->
    <script src="config.js"></script>
  </head>

  <body>
    <div class="card">
      <h1>Complete Your Registration</h1>
      <p class="small">
        Your First Name, Last Name, and Email ID have been auto-filled from your
        Google/Microsoft account.
      </p>

      <div id="error"></div>

      <form id="registrationForm">
        <div>
          <label class="required">First Name</label>
          <input id="firstName" required />
        </div>

        <div>
          <label>Middle Name</label>
          <input id="middleName" />
        </div>

        <div>
          <label class="required">Last Name</label>
          <input id="lastName" required />
        </div>

        <div>
          <label class="required">Email (from Entra)</label>
          <input id="email" type="email" readonly />
        </div>

        <div>
          <label class="required">NPI Number</label>
          <input id="npi" required />
        </div>

        <button type="submit">Submit</button>
      </form>
    </div>

    <script>
      const errorBox = document.getElementById("error");
      const firstNameInput = document.getElementById("firstName");
      const middleNameInput = document.getElementById("middleName");
      const lastNameInput = document.getElementById("lastName");
      const emailInput = document.getElementById("email");
      const npiInput = document.getElementById("npi");

      const settings = window.msalSettings || {};

      const msalConfig = {
        auth: {
          clientId: settings.clientId,
          authority: settings.authority,
          knownAuthorities: settings.knownAuthorities || [],
          redirectUri: settings.redirectUri,
        },
        cache: {
          cacheLocation: "sessionStorage",
        },
      };

      let msalInstance;

      try {
        msalInstance = new msal.PublicClientApplication(msalConfig);
      } catch (err) {
        errorBox.textContent =
          "Invalid MSAL configuration. Update config.js with tenant values.";
        console.error(err);
      }

      async function init() {
        try {
          const response = await msalInstance.handleRedirectPromise();

          if (response?.account) {
            msalInstance.setActiveAccount(response.account);
          } else {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) msalInstance.setActiveAccount(accounts[0]);
          }

          const account = msalInstance.getActiveAccount();

          if (!account) {
            errorBox.textContent =
              "No user information found. This page must be opened only after signup/login via the tenant.";
            return;
          }

          // Email
          emailInput.value = account.username || "";

          // Name
          if (account.name) {
            const parts = account.name.split(" ");
            firstNameInput.value = parts[0] || "";
            lastNameInput.value = parts.slice(1).join(" ");
          }
        } catch (err) {
          console.error("MSAL error:", err);
          errorBox.textContent =
            "Unable to load user details. Check redirect URI and tenant configuration.";
        }
      }

      init();

      document
        .getElementById("registrationForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const payload = {
            firstName: firstNameInput.value,
            middleName: middleNameInput.value,
            lastName: lastNameInput.value,
            email: emailInput.value,
            npi: npiInput.value,
          };

          console.log("Registration submitted:", payload);
          alert("Registration complete! (Dummy test page)");
        });
    </script>
  </body>
</html>
