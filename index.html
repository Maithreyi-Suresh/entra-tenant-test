<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dummy Registration Landing – Tenant Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f3f4f6;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        background: #ffffff;
        border-radius: 12px;
        padding: 24px;
        max-width: 480px;
        width: 100%;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        border: 1px solid #e5e7eb;
      }
      h1 {
        font-size: 1.25rem;
        margin: 0 0 8px;
        color: #111827;
      }
      p {
        font-size: 0.875rem;
        color: #4b5563;
        margin: 0 0 16px;
      }
      .small {
        font-size: 0.75rem;
        color: #6b7280;
      }
      form {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      label {
        font-size: 0.8rem;
        color: #374151;
        margin-bottom: 4px;
        display: block;
      }
      .required::after {
        content: " *";
        color: #ef4444;
      }
      input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 0.9rem;
      }
      input[readonly] {
        background: #f3f4f6;
        cursor: not-allowed;
      }
      button {
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        background: #2563eb;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
      }
      button:hover {
        background: #1d4ed8;
      }
      #error {
        color: #b91c1c;
        font-size: 0.8rem;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Dummy Registration Landing</h1>
      <p class="small">
        This page is only for testing. If your name and email appear below, your
        tenant’s sign-up + Google/Microsoft verification + redirect are working.
      </p>

      <div id="error"></div>

      <form id="userForm">
        <div class="field">
          <label class="required">First Name</label>
          <input type="text" id="firstName" required />
        </div>

        <div class="field">
          <label>Middle Name</label>
          <input type="text" id="middleName" />
        </div>

        <div class="field">
          <label class="required">Last Name</label>
          <input type="text" id="lastName" required />
        </div>

        <div class="field">
          <label class="required">Email (from Google/Microsoft)</label>
          <input type="email" id="email" readonly />
        </div>

        <div class="field">
          <label class="required">NPI Number</label>
          <input type="text" id="npi" required />
        </div>

        <button type="submit">Submit & Confirm Tenant Works</button>
      </form>
    </div>

    <script>
      const errorDiv = document.getElementById("error");
      const firstNameInput = document.getElementById("firstName");
      const middleNameInput = document.getElementById("middleName");
      const lastNameInput = document.getElementById("lastName");
      const emailInput = document.getElementById("email");
      const npiInput = document.getElementById("npi");
      const form = document.getElementById("userForm");

      function showError(msg) {
        errorDiv.textContent = msg || "";
      }

      function parseHashFragment() {
        // Expect something like: #id_token=....&state=...
        const hash = window.location.hash.startsWith("#")
          ? window.location.hash.substring(1)
          : window.location.hash;

        if (!hash) return {};

        return hash.split("&").reduce((acc, part) => {
          const [key, value] = part.split("=");
          if (!key) return acc;
          acc[decodeURIComponent(key)] = decodeURIComponent(value || "");
          return acc;
        }, {});
      }

      function decodeJwtPayload(token) {
        // Basic JWT decode (no signature validation — OK for this test-only page)
        const parts = token.split(".");
        if (parts.length !== 3) {
          throw new Error("Invalid ID token format");
        }
        const payload = parts[1];
        // Replace URL-safe chars and pad base64
        const base64 = payload.replace(/-/g, "+").replace(/_/g, "/");
        const padded =
          base64 + "=".repeat((4 - (base64.length % 4)) % 4);
        const json = atob(padded);
        return JSON.parse(json);
      }

      function populateFromTokenClaims(claims) {
        // Try common OIDC/AAD claims
        const givenName = claims.given_name || "";
        const familyName = claims.family_name || "";
        const fullName = claims.name || "";
        let email =
          claims.email ||
          (Array.isArray(claims.emails) ? claims.emails[0] : "") ||
          claims.preferred_username ||
          "";

        if (!email && claims.upn) {
          email = claims.upn;
        }

        if (givenName || familyName) {
          firstNameInput.value = givenName;
          lastNameInput.value = familyName;
        } else if (fullName) {
          const parts = fullName.split(" ");
          firstNameInput.value = parts[0] || "";
          lastNameInput.value = parts.slice(1).join(" ");
        }

        emailInput.value = email;
      }

      function init() {
        try {
          const params = parseHashFragment();

          if (!params.id_token) {
            showError(
              "No ID token found in the URL. " +
                "Please make sure the tenant is configured to redirect here " +
                "AFTER successful sign-up/verification with an id_token."
            );
            return;
          }

          const claims = decodeJwtPayload(params.id_token);
          populateFromTokenClaims(claims);
        } catch (e) {
          console.error(e);
          showError(
            "Failed to read user info from the ID token. Check the browser console for details."
          );
        }
      }

      init();

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const payload = {
          firstName: firstNameInput.value,
          middleName: middleNameInput.value,
          lastName: lastNameInput.value,
          email: emailInput.value,
          npi: npiInput.value,
        };
        console.log("Dummy registration submitted:", payload);
        alert(
          "Form submitted!\nIf name and email were auto-filled, your tenant flow is working."
        );
      });
    </script>
  </body>
</html>
