<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tenant Registration</title>
 <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
  <script src="config.js"></script>
</head>
<body>
  <h2>Tenant Registration Form</h2>
  <div id="error" style="color: red;"></div>

  <form id="registrationForm">
    <label>First Name: <input id="firstName" required /></label><br />
    <label>Last Name: <input id="lastName" required /></label><br />
    <label>Email: <input id="email" type="email" readonly /></label><br />
    <label>NPI Number: <input id="npi" required /></label><br />
    <button type="submit">Submit</button>
  </form>

  <script>
    const errorBox = document.getElementById("error");
    const firstNameInput = document.getElementById("firstName");
    const lastNameInput = document.getElementById("lastName");
    const emailInput = document.getElementById("email");
    const npiInput = document.getElementById("npi");

    window.addEventListener("DOMContentLoaded", async () => {
      if (typeof msal === "undefined") {
        errorBox.textContent = "MSAL not loaded!";
        return;
      }

      const msalInstance = new msal.PublicClientApplication({
        auth: {
          clientId: window.msalSettings.auth.clientId,
          authority: window.msalSettings.auth.authority,
          redirectUri: window.msalSettings.auth.redirectUri,
          knownAuthorities: window.msalSettings.auth.knownAuthorities,
        },
        cache: window.msalSettings.cache,
      });

      try {
        const response = await msalInstance.handleRedirectPromise();

        if (response?.account) {
          msalInstance.setActiveAccount(response.account);
        } else {
          const accounts = msalInstance.getAllAccounts();
          if (accounts.length > 0) msalInstance.setActiveAccount(accounts[0]);
        }

        const account = msalInstance.getActiveAccount();

        // ✅ Redirect to login if no active account
        if (!account) {
          await msalInstance.loginRedirect({
            scopes: ["openid", "profile", "email"],
          });
          return;
        }

        const tokenResp = await msalInstance.acquireTokenSilent({
          scopes: ["openid", "profile", "email"],
          account,
        });

        const claims = tokenResp.idTokenClaims || {};
        firstNameInput.value = claims.given_name || "";
        lastNameInput.value = claims.family_name || "";
        emailInput.value = claims.email || claims.preferred_username || "";

      } catch (err) {
        console.error("MSAL error:", err);
        errorBox.textContent = "Unable to load user details. Check config and tenant setup.";
      }

      document.getElementById("registrationForm").addEventListener("submit", (e) => {
        e.preventDefault();

        const payload = {
          firstName: firstNameInput.value,
          lastName: lastNameInput.value,
          email: emailInput.value,
          npi: npiInput.value,
        };

        console.log("✅ Registration Submitted:", payload);
        alert("Form submitted!");
      });
    });
  </script>
</body>
</html>


